<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>English Speaking Course</title>

  <style>
    /* Reset & base */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f0e8;
      color: #222;
      min-height: 100vh;
    }

    /* Navigation */
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 3rem;
      background: #d4c7b8;
      font-weight: 600;
      letter-spacing: 1px;
      font-size: 1rem;
    }
    nav .logo { font-weight: 900; font-size: 1.25rem; cursor: pointer; user-select: none; }
    nav ul { list-style: none; display: flex; gap: 2rem; }
    nav ul li { cursor: pointer; }
    nav ul li a { text-decoration: none; color: inherit; }

    /* Sections */
    .section {
      padding: 50px 3rem;
      max-width: 900px;
      margin: 30px auto;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      border-radius: 8px;
      background: #fff;
      display: none; /* hidden by default */
    }

    #heroSection {
      height: 70vh;
      background: url('{{ url_for('static', filename='background.jpg') }}') center/cover no-repeat;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 0 2rem;
      color: #ede6dc;
      text-shadow: 0 0 10px rgba(0,0,0,0.7);
      margin-bottom: 30px;
    }
    #heroSection h1 { font-size: 3rem; max-width: 800px; line-height: 1.2; }

    h2 { text-align: center; margin-bottom: 20px; }
    p { font-size: 1.125rem; line-height: 1.6; text-align: center; color: #333; }

    #status { margin-bottom: 10px; font-weight: bold; text-align: center; }
    #response span.wrong { background-color: #ffcdd2; border-radius: 4px; padding: 2px 4px; }
    #app { text-align: center; }
    button#startBtn {
      cursor: pointer;
      background-color: #d4c7b8;
      border: none;
      padding: 12px 25px;
      font-size: 1.1rem;
      border-radius: 6px;
      font-weight: 600;
      transition: background-color 0.3s ease;
      display: block;
      margin: 0 auto 30px;
    }
    button#startBtn:hover { background-color: #b3a48b; }

    @media (max-width: 768px) {
      nav ul { gap: 1rem; }
      #heroSection h1 { font-size: 2rem; }
      h2 { font-size: 2rem; }
    }
  </style>

  <script src="{{ url_for('static', filename='activity.js') }}"></script>
</head>
<body>

<nav>
  <div class="logo" id="homeLink">ENGLISH SPEAKING COURSE</div>
  <ul>
    <li><a href="#" id="aboutLink">About</a></li>
    <li><a href="#" id="speakingTestLink">Speaking Test</a></li>
    <li><a href="#" id="activityLink">Activity</a></li>
    <li><a href="#" id="materialsLink">Learning Materials</a></li>
  </ul>
</nav>

<!-- Hero Section -->
<section id="heroSection">
  <h1>EMPOWERING YOUR EDUCATIONAL JOURNEY</h1>
</section>

<!-- About Us -->
<section id="about-us" class="section">
  <h2>About Us</h2>
  <p>
    Welcome to our English Speaking Course! Our mission is to empower learners by providing
    interactive coaching that improves fluency, pronunciation, and confidence.  
    Whether you're a beginner or looking to perfect your skills, our personalized speaking tests,
    AI feedback, and supportive community help you on your educational journey every step of the way.
  </p>
</section>

<!-- Speaking Test -->
<section id="speaking-test" class="section">
  <button onclick="startApp()" id="startBtn">â–¶ Start Coaching</button>
  <div id="app">
    <h2>English Speaking Coach</h2>
    <p id="status">Initializing...</p>
    <p><strong>Your speech:</strong></p>
    <div id="transcript"></div>
    <p><strong>AI Response:</strong></p>
    <div id="response"></div>
  </div>
</section>

<!-- Activity -->
<section id="activity" class="section">
  <h2>Your Activity</h2>
  <p><strong>Exercises completed:</strong> <span id="activityCount"></span></p>
  <p><strong>Last active:</strong> <span id="activityLast"></span></p>
</section>

<!-- Learning Materials -->
<section id="materials" class="section">
  <h2>Learning Materials</h2>
  <p>
    Welcome to the Learning Materials page! Our tool aims to support you in your English learning journey by helping you practice speaking.
    However, learning a language is not just about conversations! To help you learn the right grammatical structure in English, you can try some of the materials below:
  </p>
</section>

<script>
  function hideAllSections() {
    document.getElementById('about-us').style.display = 'none';
    document.getElementById('speaking-test').style.display = 'none';
    document.getElementById('activity').style.display = 'none';
    document.getElementById('materials').style.display = 'none';
    document.getElementById('heroSection').style.display = 'none';
  }

  // Show hero by default
  document.getElementById('heroSection').style.display = 'flex';

  // Navigation handlers
  document.getElementById('homeLink').addEventListener('click', function(e){
    e.preventDefault();
    hideAllSections();
    document.getElementById('heroSection').style.display = 'flex';
  });

  document.getElementById('aboutLink').addEventListener('click', function(e){
    e.preventDefault();
    hideAllSections();
    document.getElementById('about-us').style.display = 'block';
  });

  document.getElementById('speakingTestLink').addEventListener('click', function(e){
    e.preventDefault();
    hideAllSections();
    document.getElementById('speaking-test').style.display = 'block';
  });

  document.getElementById('activityLink').addEventListener('click', function(e){
    e.preventDefault();
    hideAllSections();
    document.getElementById('activity').style.display = 'block';
    document.getElementById('activityCount').textContent = getActivity();
    document.getElementById('activityLast').textContent = getLastActive();
  });

  document.getElementById('materialsLink').addEventListener('click', function(e){
    e.preventDefault();
    hideAllSections();
    document.getElementById('materials').style.display = 'block';
  });

  // Speaking coach app
  let mediaRecorder;
  let chunks = [];
  let silenceTimer;
  const silenceDuration = 2000;

  function startApp() {
    document.getElementById("startBtn").style.display = "none";
    document.getElementById("app").style.display = "block";
    startRecordingLoop();
  }

  async function startRecordingLoop() {
    document.getElementById("status").textContent = "Listening...";
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const audioCtx = new AudioContext();
    const source = audioCtx.createMediaStreamSource(stream);
    const analyser = audioCtx.createAnalyser();
    source.connect(analyser);
    const data = new Uint8Array(analyser.fftSize);

    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();
    chunks = [];

    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = async () => {
      document.getElementById("status").textContent = "Processing...";
      const blob = new Blob(chunks, { type: "audio/wav" });
      const formData = new FormData();
      formData.append("audio", blob, "audio.wav");

      const res = await fetch("/process_audio", { method: "POST", body: formData });
      const data = await res.json();
      document.getElementById("transcript").textContent = data.user;
      renderCorrection(data.assistant);
      increaseActivity();
      const audio = new Audio(`/static/audio_reply.mp3?ts=${Date.now()}`);
      audio.oncanplaythrough = () => audio.play().catch(err => alert("Audio playback failed."));
      audio.onended = () => setTimeout(() => startRecordingLoop(), 1000);
    };

    detectSilence(analyser, data, () => {
      mediaRecorder.stop();
      stream.getTracks().forEach(t => t.stop());
      audioCtx.close();
    });
  }

  function detectSilence(analyser, dataArray, onSilence) {
    clearInterval(silenceTimer);
    let silentFor = 0;
    silenceTimer = setInterval(() => {
      analyser.getByteTimeDomainData(dataArray);
      const max = Math.max(...dataArray);
      const min = Math.min(...dataArray);
      const amplitude = max - min;
      if (amplitude < 10) {
        silentFor += 200;
        if (silentFor > silenceDuration) {
          clearInterval(silenceTimer);
          onSilence();
        }
      } else silentFor = 0;
    }, 200);
  }

  function renderCorrection(reply) {
    const match = reply.match(/wrong:(.*?)\s+right:(.*?)\b/i);
    let html = reply;
    if (match) html = reply.replace(match[1], `<span class="wrong">${match[1]}</span>`);
    document.getElementById("response").innerHTML = html;
    document.getElementById("status").textContent = "Waiting for next round...";
  }
</script>

</body>
</html>

